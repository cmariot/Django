{% comment %} Bootstrap JS Scripts {% endcomment %}

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>



{% comment %} Login script {% endcomment %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    function getCSRFToken() {
        return getCookie('csrftoken');
    }


    // Submit login form
    $(document).on('submit', '#login-form', function(event) {
        event.preventDefault();
        $.ajax({
            url: '{% url "login" %}',
            type: 'POST',
            data: {
                username: $('#id_username').val(),
                password: $('#id_password').val(),
                csrfmiddlewaretoken: getCSRFToken()
            },
            success: function(response) {
                if (!response.success) {
                    console.log("Error")
                    console.log(response.errors);
                    //let errorlists = $('.errorlist');
                    //for (let i = 0; i < errorlists.length; i++) {
                    //    errorlists[i].innerHTML = '';
                    //}
                    //$.each(response.errors, function(key, value) {
                    //    console.log(key, value);
                    //    let field_ul = $('#'+ key + '_errors');
                    //    // $.each(value, function(index, error) {
                    //    //     field_ul.append('<li class="alert alert-danger">' + error + '</li>');
                    //    // });
                    //});
                } else {
                    console.log('success');
                    $.ajax({
                        url: '{% url "account" %}',
                        type: 'GET',
                        success: function(response) {
                            $('body').html(response);
                        }
                    });
                }
            }
        });
    });

    // Submit register form
    $(document).on('submit', '#register-form', function(event) {
        event.preventDefault();
        $.ajax({
            url: '{% url "register" %}',
            type: 'POST',
            data: {
                username: $('#id_username').val(),
                password1: $('#id_password1').val(),
                password2: $('#id_password2').val(),
                csrfmiddlewaretoken: getCSRFToken()
            },
            success: function(response) {
                if (!response.success) {
                    let errorlists = $('.errorlist');
                    for (let i = 0; i < errorlists.length; i++) {
                        errorlists[i].innerHTML = '';
                    }
                    $.each(response.errors, function(key, value) {
                        let field_ul = $('#'+ key + '_errors');
                        $.each(value, function(index, error) {
                            field_ul.append('<li class="alert alert-danger">' + error + '</li>');
                        });
                    });
                } else {
                    console.log('success');
                    $.ajax({
                        url: '{% url "account" %}',
                        type: 'GET',
                        success: function(response) {
                            $('body').html(response);
                        }
                    });
                }
            }
        });
    });

    $(document).on('click', '.register', function(event) {
        event.preventDefault();
        $.ajax({
            url: '{% url "register" %}',
            type: 'GET',
            success: function(response) {
                $('main').html(response);
            }
        });
    });

    $(document).on('click', '.login', function(event) {
        event.preventDefault();
        $.ajax({
            url: '{% url "login" %}',
            type: 'GET',
            success: function(response) {
                $('main').html(response);
            }
        });
    });

</script>


